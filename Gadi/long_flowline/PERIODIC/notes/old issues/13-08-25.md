# Date: 2025-08-13 

Continuing from Date: 2025-08-12 

## Felicity's Advice
Decrease time step to 1/12 years at least  

# INITIAL PROBLEM: 
üîé **setup_non_periodic_boundary_conditions(md):**
DEACTIVATED velocity cap (v_est) this lead to Extreme velocities (~millions m/a) in diagnostic runs leading to crashed transient runs

## Coarsest Resolution S1
```

...

Surface velocity ranges (m a‚Åª¬π):
  vx: [-0.14, 1814.27]
  vy: [-1295.46, 26.74]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S1_1.5_static.txt with shape (1583, 4)
First 5 rows:
[[1.00000000e+00 1.81426579e+03 0.00000000e+00 0.00000000e+00]
 [9.99367889e-01 1.81270179e+03 0.00000000e+00 0.00000000e+00]
 [9.98735777e-01 1.81036730e+03 0.00000000e+00 0.00000000e+00]
 [9.98103666e-01 1.80636331e+03 0.00000000e+00 0.00000000e+00]
 [9.97471555e-01 1.80016486e+03 0.00000000e+00 0.00000000e+00]]
‚úì output saved: 165_S1_1.5_static.txt

...

iteration 1/5400  time [yr]: 0.06 (time step: 0.06)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...
   computing slope
   computing basal mass balance
   computing basal mass balance
   computing mass transport
   call free surface computational core
   extruding Base from base...
   extruding solution from top...
   extruding solution from top...
   extruding solution from top...
   updating vertices positions
   computing transient requested outputs
   saving temporary results
iteration 2/5400  time [yr]: 0.11 (time step: 0.06)
...

iteration 7/5400  time [yr]: 0.39 (time step: 0.06)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...
   computing slope
   computing basal mass balance

...   
^C
KeyboardInterrupt
```
S1 DOESN't automatically crash, this might be a good sign.


## Coarsest Resolution S2
```
...

Surface velocity ranges (m a‚Åª¬π):
  vx: [0.00, 8328888.10]
  vy: [-9194322.70, 64.48]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S2_1.5_static.txt with shape (1583, 4)
First 5 rows:
[[1.00000000e+00 8.12747976e+06 0.00000000e+00 0.00000000e+00]
 [9.99367889e-01 8.12741040e+06 0.00000000e+00 0.00000000e+00]
 [9.98735777e-01 8.13533216e+06 0.00000000e+00 0.00000000e+00]
 [9.98103666e-01 8.14777163e+06 0.00000000e+00 0.00000000e+00]
 [9.97471555e-01 8.17070132e+06 0.00000000e+00 0.00000000e+00]]
‚úì output saved: 165_S2_1.5_static.txt

...

iteration 1/5400  time [yr]: 0.06 (time step: 0.06)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...
   computing slope
   computing basal mass balance
   computing basal mass balance
   computing mass transport
   call free surface computational core
   extruding Base from base...
   extruding solution from top...
   extruding solution from top...
   extruding solution from top...
   updating vertices positions
   computing transient requested outputs
   saving temporary results
iteration 2/5400  time [yr]: 0.11 (time step: 0.06)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...

[0] ??? Error using ==> ./classes/Elements/TriaRef.cpp:117
[0] GetJacobianDeterminant error message: negative jacobian determinant!

--------------------------------------------------------------------------
Primary job  terminated normally, but 1 process returned
a non-zero exit code. Per user-direction, the job has been aborted.
--------------------------------------------------------------------------
--------------------------------------------------------------------------
mpiexec detected that one or more processes exited with non-zero status, thus causing
the job to be terminated. The first process to do so was:

  Process name: [[57900,1],0]
  Exit code:    1
--------------------------------------------------------------------------
loading results from cluster
Solving complete - saving results
field md.solidearth.external is None
qmu is skipped until it is more stable
(.venv) ana@MU00236940:~/Desktop/code/Gadi/flowline
```
S2 CRASHESmmmmmh thats suspicious lets try S4

## Coarsest Resolution S4
```
... 

Surface velocity ranges (m a‚Åª¬π):
  vx: [0.00, 8356274.20]
  vy: [-9223655.32, 80.15]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [-5875.86, 34261.55]
‚úì Saved 165_S4_1.5_static.txt with shape (1583, 4)
First 5 rows:
[[1.00000000e+00 8.15421891e+06 0.00000000e+00 0.00000000e+00]
 [9.99367889e-01 8.15414961e+06 0.00000000e+00 3.81083345e+00]
 [9.98735777e-01 8.16209473e+06 0.00000000e+00 7.80741326e+00]
 [9.98103666e-01 8.17456888e+06 0.00000000e+00 1.14133438e+01]
 [9.97471555e-01 8.19756299e+06 0.00000000e+00 1.51946105e+01]]
‚úì output saved: 165_S4_1.5_static.txt

...

call computational core:
iteration 1/5400  time [yr]: 0.06 (time step: 0.06)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...
   computing slope
   computing basal mass balance
   computing basal mass balance
   computing mass transport
   call free surface computational core
   extruding Base from base...
   extruding solution from top...
   extruding solution from top...
   extruding solution from top...
   updating vertices positions
   computing transient requested outputs
   saving temporary results
iteration 2/5400  time [yr]: 0.11 (time step: 0.06)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...

[0] ??? Error using ==> ./classes/Elements/TriaRef.cpp:117
[0] GetJacobianDeterminant error message: negative jacobian determinant!

--------------------------------------------------------------------------
Primary job  terminated normally, but 1 process returned
a non-zero exit code. Per user-direction, the job has been aborted.
--------------------------------------------------------------------------
```

The crashing appears more obviously in the n=3 rheology cases (S2, S4) with the current simulation setup.

It looks like a runaway effect: High velocities ‚Üí high strain rates ‚Üí low viscosity ‚Üí even higher velocities

================================================================================


FM suggested that a ~30kPa value in the driving stress didn't seem too wacky THEREFORE: I TRIED IMPLEMENTING PERIODIC BCS

# FIXED problem from 12-08-25 docs:
Domain Ending at Bedrock Trough
Profile 165 ends at a **trough** (low point) in bedrock undulations, creating:
- Steep upward slope at terminus
- **Massive driving stress**: 428,037 Pa at terminus vs 51,290 Pa at inlet
- Driving stress difference: **376,748 Pa** (7x difference!)
- This might be causing extreme velocities, especially with nonlinear rheology (n=3)

 by making sure that there are an integer number of periods in the domain I tried implementing periodic BCS using my previous method ... THIS APPEARS TO WORK!!! 


## Example Stress Balance Output for 1.0 Resolution S2
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [9.44, 49.15]
  vy: [-66.17, 65.10]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S2_1.25_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         39.02167509  0.          0.        ]
 [ 0.99936789 37.806196    0.          0.        ]
 [ 0.99873578 36.70850996  0.          0.        ]
 [ 0.99810367 34.90336087  0.          0.        ]
 [ 0.99747155 33.24751042  0.          0.        ]]
‚úì output saved: 165_S2_1.25_static.txt

```

the range of velocities for all SX in the stress balance output is of this scale!


i did notice that the S1 sim crashes when testing the 0.5 resolution (2 timesteps)! While an obvious crash (within the first 5 timesteps) doesn't occur for S2 or S3 or S4 for 0.5 res


## Important Points and Questions for Felicity and Jason

1. My driving stress was looking problematic and it was preventing me from setting periodic BCS like in ISMIP-HOM... now I get 
```
=== DRIVING STRESS DIAGNOSTIC S2 ===
Surface elevation: 1943.400 to 1668.609 m
Bed elevation: 23.400 to -251.391 m
Ice thickness: 1920.000 to 1920.000 m

Systematic trends over 158 km:
  Surface: -274.791 m (-1.736 m/km)
  Bed: -274.791 m (-1.736 m/km)
  Thickness: 0.000 m (0.000 m/km)

Driving stress at boundaries:
  Left (x=0): 51298.2 Pa
  Right (x=L): 14453.5 Pa
  Difference: 36844.6 Pa <<<< REASONABLE VALUE according to both FM and JR 
```
Q. **WHAT ARE REASONABLE VELOCITIES???** is ismip hom a good benchmark?
RN all my exp stress balance diagnostics of vel are below 100 m per year

YES!

JASON: The ratios of Vx/Vy look reasonable too!
====================================================================================
JASON FOUND A BUG IN MY CODE
THE TIMESTEP WAS BEING divided by resolution_factor (it should be multiplied!)
====================================================================================
SHOULD CHECK CFL criterion to determine adequate timestep size!

## S1 Resolution Factor = 1.25
Total vertices: 32483
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [1.84, 23.56]
  vy: [-27.51, 26.89]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S1_1.25_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         12.72719303  0.          0.        ]
 [ 0.99936789 11.72882771  0.          0.        ]
 [ 0.99873578 10.8020779   0.          0.        ]
 [ 0.99810367  9.77407725  0.          0.        ]
 [ 0.99747155  8.90412244  0.          0.        ]]
‚úì output saved: 165_S1_1.25_static.txt

...

iteration 1/2881  time [yr]: 0.10 (time step: 0.10)

```


## S1 Resolution Factor = 1.0
Total vertices: 32240

```
Surface velocity ranges (m a‚Åª¬π):
  vx: [1.85, 23.54]
  vy: [-27.49, 26.91]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S1_1.0_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         12.72879373  0.          0.        ]
 [ 0.99936789 11.73974392  0.          0.        ]
 [ 0.99873578 10.8127976   0.          0.        ]
 [ 0.99810367  9.78471039  0.          0.        ]
 [ 0.99747155  8.89414679  0.          0.        ]]
‚úì output saved: 165_S1_1.0_static.txt

...

iteration 1/3600  time [yr]: 0.08 (time step: 0.08)

```


## S1 Resolution Factor = 0.75
Total vertices: 36470

```
Surface velocity ranges (m a‚Åª¬π):
  vx: [1.83, 23.55]
  vy: [-27.50, 26.94]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S1_0.75_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         12.71125097  0.          0.        ]
 [ 0.99936789 11.74884165  0.          0.        ]
 [ 0.99873578 10.78644867  0.          0.        ]
 [ 0.99810367  9.83344287  0.          0.        ]
 [ 0.99747155  8.92218757  0.          0.        ]]
‚úì output saved: 165_S1_0.75_static.txt

...

iteration 1/4800  time [yr]: 0.06 (time step: 0.06)

```


## S1 Resolution Factor = 0.5
Total vertices: 89246
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [1.86, 23.54]
  vy: [-27.52, 26.94]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S1_0.5_static.txt with shape (3165, 4)
First 5 rows:
[[ 1.         12.71371712  0.          0.        ]
 [ 0.99936789 11.75020616  0.          0.        ]
 [ 0.99873578 10.78049107  0.          0.        ]
 [ 0.99810367  9.84135495  0.          0.        ]
 [ 0.99747155  8.93529589  0.          0.        ]]
‚úì output saved: 165_S1_0.5_static.txt

...

iteration 1/7201  time [yr]: 0.04 (time step: 0.04)
...

iteration 2/7200  time [yr]: 0.08 (time step: 0.04)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...

[0] ??? Error using ==> ./classes/Elements/TriaRef.cpp:117
[0] GetJacobianDeterminant error message: negative jacobian determinant!

--------------------------------------------------------------------------
Primary job  terminated normally, but 1 process returned
a non-zero exit code. Per user-direction, the job has been aborted.
--------------------------------------------------------------------------



```

THESE timesteps increasing with resolution_factor ACTUALLY MAKE SENSE... however the S1 case still crashes at the second timestep (?)


## S2 Resolution Factor = 1.25
Total vertices: 32483

```
Surface velocity ranges (m a‚Åª¬π):
  vx: [9.44, 49.15]
  vy: [-66.17, 65.10]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S2_1.25_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         39.02167509  0.          0.        ]
 [ 0.99936789 37.806196    0.          0.        ]
 [ 0.99873578 36.70850996  0.          0.        ]
 [ 0.99810367 34.90336087  0.          0.        ]
 [ 0.99747155 33.24751042  0.          0.        ]]
‚úì output saved: 165_S2_1.25_static.txt

...

iteration 1/2881  time [yr]: 0.10 (time step: 0.10)

```


## S2 Resolution Factor = 1.0
Total vertices: 32240
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [9.44, 49.19]
  vy: [-66.19, 65.33]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S2_1.0_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         39.13456943  0.          0.        ]
 [ 0.99936789 37.99187161  0.          0.        ]
 [ 0.99873578 36.72087601  0.          0.        ]
 [ 0.99810367 34.89566523  0.          0.        ]
 [ 0.99747155 33.20330873  0.          0.        ]]
‚úì output saved: 165_S2_1.0_static.txt

...

iteration 1/3600  time [yr]: 0.08 (time step: 0.08)

```


## S2 Resolution Factor = 0.75
Total vertices: 36470

```
Surface velocity ranges (m a‚Åª¬π):
  vx: [9.42, 49.04]
  vy: [-66.18, 65.44]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S2_0.75_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         39.02350529  0.          0.        ]
 [ 0.99936789 37.93565187  0.          0.        ]
 [ 0.99873578 36.60153199  0.          0.        ]
 [ 0.99810367 35.04634923  0.          0.        ]
 [ 0.99747155 33.24907218  0.          0.        ]]
‚úì output saved: 165_S2_0.75_static.txt

...

call computational core:
iteration 1/4800  time [yr]: 0.06 (time step: 0.06)

```


## S2 Resolution Factor = 0.5
Total vertices: 89246

```
Surface velocity ranges (m a‚Åª¬π):
  vx: [9.41, 49.00]
  vy: [-66.18, 65.15]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [0.00, 0.00]
‚úì Saved 165_S2_0.5_static.txt with shape (3165, 4)
First 5 rows:
[[ 1.         39.06411969  0.          0.        ]
 [ 0.99936789 37.93720396  0.          0.        ]
 [ 0.99873578 36.61717579  0.          0.        ]
 [ 0.99810367 35.10015922  0.          0.        ]
 [ 0.99747155 33.28570838  0.          0.        ]]
‚úì output saved: 165_S2_0.5_static.txt

...

iteration 1/7201  time [yr]: 0.04 (time step: 0.04)

```

<!-- ~~~~~~~~~~~~ -->

## S3 Resolution Factor = 1.25
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [23.06, 41.53]
  vy: [-34.36, 33.82]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [3.93, 37.21]
‚úì Saved 165_S3_1.25_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         33.85810113  0.         20.50480266]
 [ 0.99936789 33.15986935  0.         22.09281536]
 [ 0.99873578 32.53768821  0.         23.75533934]
 [ 0.99810367 31.78292117  0.         25.36423488]
 [ 0.99747155 31.19975879  0.         26.90440462]]
‚úì output saved: 165_S3_1.25_static.txt

...

iteration 1/2881  time [yr]: 0.10 (time step: 0.10)

```


## S3 Resolution Factor = 1.0
Total vertices: 32240
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [23.10, 41.51]
  vy: [-34.30, 33.85]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [3.90, 37.19]
‚úì Saved 165_S3_1.0_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         33.86410985  0.         20.49533116]
 [ 0.99936789 33.1762201   0.         22.07841863]
 [ 0.99873578 32.55042866  0.         23.74416663]
 [ 0.99810367 31.79211851  0.         25.34857926]
 [ 0.99747155 31.18390776  0.         26.90366034]]
‚úì output saved: 165_S3_1.0_static.txt

...

iteration 1/3600  time [yr]: 0.08 (time step: 0.08)

```


## S3 Resolution Factor = 0.75
Total vertices: 36470

```

Surface velocity ranges (m a‚Åª¬π):
  vx: [23.08, 41.51]
  vy: [-34.35, 33.87]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [3.89, 37.17]
‚úì Saved 165_S3_0.75_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         33.84505537  0.         20.49535822]
 [ 0.99936789 33.18759851  0.         22.07024578]
 [ 0.99873578 32.52133274  0.         23.74419186]
 [ 0.99810367 31.85492953  0.         25.34821248]
 [ 0.99747155 31.22081464  0.         26.90235252]]
‚úì output saved: 165_S3_0.75_static.txt

...

iteration 1/4800  time [yr]: 0.06 (time step: 0.06)
```


## S3 Resolution Factor = 0.5
Total vertices: 89246
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [23.12, 41.51]
  vy: [-34.33, 33.82]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [4.00, 37.07]
‚úì Saved 165_S3_0.5_static.txt with shape (3165, 4)
First 5 rows:
[[ 1.         33.84843715  0.         20.50464246]
 [ 0.99936789 33.18718536  0.         22.10990758]
 [ 0.99873578 32.51039075  0.         23.73729855]
 [ 0.99810367 31.85856816  0.         25.33251206]
 [ 0.99747155 31.2279136   0.         26.87636087]]
‚úì output saved: 165_S3_0.5_static.txt

...

iteration 1/7201  time [yr]: 0.04 (time step: 0.04)

...

iteration 2/7200  time [yr]: 0.08 (time step: 0.04)
   computing new velocity
computing slope...
   extruding SurfaceSlopeX from base...

[0] ??? Error using ==> ./classes/Elements/TriaRef.cpp:117
[0] GetJacobianDeterminant error message: negative jacobian determinant!

--------------------------------------------------------------------------
Primary job  terminated normally, but 1 process returned
a non-zero exit code. Per user-direction, the job has been aborted.
--------------------------------------------------------------------------
--------------------------------------------------------------------------
mpiexec detected that one or more processes exited with non-zero status, thus causing
the job to be terminated. The first process to do so was:

  Process name: [[20471,1],0]
  Exit code:    1
--------------------------------------------------------------------------
loading results from cluster
Solving complete - saving results

```

<!-- ~~~~~~~~~~~~ -->

## S4 Resolution Factor = 1.25
Total vertices: 32483
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [32.14, 63.97]
  vy: [-82.38, 81.29]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [-7.74, 50.74]
‚úì Saved 165_S4_1.25_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         56.49428181  0.         19.77300393]
 [ 0.99936789 56.10039617  0.         22.61063799]
 [ 0.99873578 55.89221675  0.         25.51174893]
 [ 0.99810367 55.01997114  0.         28.39819569]
 [ 0.99747155 54.34544967  0.         31.13469389]]
‚úì output saved: 165_S4_1.25_static.txt

...

iteration 1/2881  time [yr]: 0.10 (time step: 0.10)

```


## S4 Resolution Factor = 1.0
Total vertices: 32240
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [32.15, 63.78]
  vy: [-81.73, 80.81]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [-7.69, 50.65]
‚úì Saved 165_S4_1.0_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         56.29020622  0.         19.73692123]
 [ 0.99936789 56.0073448   0.         22.48613978]
 [ 0.99873578 55.67214287  0.         25.43905653]
 [ 0.99810367 54.76980034  0.         28.31094534]
 [ 0.99747155 54.0537011   0.         31.08290752]]
‚úì output saved: 165_S4_1.0_static.txt

...

iteration 1/3600  time [yr]: 0.08 (time step: 0.08)

```


## S4 Resolution Factor = 0.75
Total vertices: 36470
```
Surface velocity ranges (m a‚Åª¬π):
  vx: [32.15, 63.95]
  vy: [-82.46, 81.83]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [-7.71, 50.69]
‚úì Saved 165_S4_0.75_static.txt with shape (1583, 4)
First 5 rows:
[[ 1.         56.65204042  0.         19.79258446]
 [ 0.99936789 56.43329669  0.         22.4652729 ]
 [ 0.99873578 56.00801807  0.         25.44942814]
 [ 0.99810367 55.38551846  0.         28.32863775]
 [ 0.99747155 54.544057    0.         31.11397502]]
‚úì output saved: 165_S4_0.75_static.txt

...

iteration 1/4800  time [yr]: 0.06 (time step: 0.06)

```


## S4 Resolution Factor = 0.5
Total vertices: 89246

```
Surface velocity ranges (m a‚Åª¬π):
  vx: [32.13, 64.04]
  vy: [-82.38, 81.61]
  vz: [0.00, 0.00]
Basal velocity ranges (m a‚Åª¬π):
  vx_basal: [-7.66, 50.45]
‚úì Saved 165_S4_0.5_static.txt with shape (3165, 4)
First 5 rows:
[[ 1.         56.74593713  0.         19.82899319]
 [ 0.99936789 56.47496503  0.         22.61732712]
 [ 0.99873578 56.05140818  0.         25.48485833]
 [ 0.99810367 55.46287336  0.         28.28933291]
 [ 0.99747155 54.60206563  0.         31.04033717]]
‚úì output saved: 165_S4_0.5_static.txt

...

iteration 1/7201  time [yr]: 0.04 (time step: 0.04)

```


# Observations

Linear runs seem to crash rapidly at the finest resolution factor (0.5)!

will ommit 0.5 from the resolution testing


...


# CRASHED RUN

WHEN RUNNING periodic_flowline.py for 0.75 -> 1.25 for S1 -> S4 in su58

I encountered: 
```
‚óè These errors are from ISSM (Ice Sheet System Model), a scientific
  computing software for ice sheet modeling. The errors indicate:

  Root Cause: An assertion failure in the mesh generation code at
  CreateNodes.cpp:610. The assertion "numvertex_pairing==0 || 
  finite_element==P1Enum" is failing, meaning the code expects either:
  - No vertex pairing (numvertex_pairing==0), OR
  - P1 finite elements (finite_element==P1Enum)

  But neither condition is being met.

  What's happening:
  - Multiple parallel processes (ranks 0-11) are all failing with the same
  assertion
  - This suggests a configuration issue with your finite element setup
  - The model is trying to create nodes but the finite element type and
  vertex pairing settings are incompatible

  Likely fixes:
  1. Check your finite element configuration - ensure you're using P1
  elements if you have vertex pairing enabled
  2. Review your mesh generation parameters
  3. Verify your model setup doesn't have conflicting finite element and
  meshing options

  The error message suggests reporting this as a bug, but it's more likely
  a configuration issue in your model setup.

> look into my simulation script S3/165/0.75/periodic_flowline.py I think the issue 
  might be P1 finite elements (finite_element==P1Enum)
  but I am not sure

‚óè Read(S3/165/0.75/periodic_flowline.py)
  ‚éø ¬†Read 793 lines (ctrl+r to expand)

‚óè Looking at line 612, the finite element choice is set in this code:

  exp = 'S4' # Grid convergence study
  rheology_n = 3

  And around line 706, the flow equation is configured:

  md = setflowequation(md, 'FS', 'all')

  The issue is likely that your simulation is using Full-Stokes (FS) equations, which
  typically use P2/P1 finite elements (P2 for velocity, P1 for pressure) rather than
  P1 elements. However, your periodic boundary setup with vertex pairing at lines
  747-749 expects P1 elements.

  To fix this, you have two options:

  1. Change to P1 elements by using SSA (Shallow Shelf Approximation) or HO (Higher
  Order):
  md = setflowequation(md, 'SSA', 'all')  # or 'HO'
  2. Disable vertex pairing if you want to keep Full-Stokes:
  # Comment out the periodic boundary setup
  # md = setup_periodic_boundaries(md)

  The assertion "numvertex_pairing==0 || finite_element==P1Enum" means either no
  vertex pairing OR P1 elements must be used. Your current setup has vertex pairing
  with P2/P1 elements, which violates this constraint.

```

‚óè These errors are from ISSM (Ice Sheet System Model), a scientific
  computing software for ice sheet modeling. The errors indicate:

  Root Cause: An assertion failure in the mesh generation code at
  CreateNodes.cpp:610. The assertion "numvertex_pairing==0 || 
  finite_element==P1Enum" is failing, meaning the code expects either:
  - No vertex pairing (numvertex_pairing==0), OR
  - P1 finite elements (finite_element==P1Enum)

  But neither condition is being met.

  What's happening:
  - Multiple parallel processes (ranks 0-11) are all failing with the same
  assertion
  - This suggests a configuration issue with your finite element setup
  - The model is trying to create nodes but the finite element type and
  vertex pairing settings are incompatible

  Likely fixes:
  1. Check your finite element configuration - ensure you're using P1
  elements if you have vertex pairing enabled
  2. Review your mesh generation parameters
  3. Verify your model setup doesn't have conflicting finite element and
  meshing options

  The error message suggests reporting this as a bug, but it's more likely
  a configuration issue in your model setup.

from periodic_flowline.py I think the issue might be not satisfying P1 finite elements (finite_element==P1Enum)
  but I am not sure. CHECKING in periodic_flowline.py line 612, the finite element choice is set in this code:

  And around line 706, the flow equation is configured:

  md = setflowequation(md, 'FS', 'all')

  The issue is likely that your simulation is using Full-Stokes (FS) equations, which
  typically use P2/P1 finite elements (P2 for velocity, P1 for pressure) rather than
  P1 elements. However, your periodic boundary setup with vertex pairing at lines
  747-749 expects P1 elements.

ACCORDING TO CLAUDE:

  To fix this, you have two options:

  1. Change to P1 elements by using SSA (Shallow Shelf Approximation) or HO (Higher
  Order):
  md = setflowequation(md, 'SSA', 'all')  # or 'HO'
  2. Disable vertex pairing if you want to keep Full-Stokes:


  The assertion "numvertex_pairing==0 || finite_element==P1Enum" means either no
  vertex pairing OR P1 elements must be used. The current setup has vertex pairing
  with P2/P1 elements, which violates this constraint.



changing from 'FS' (Full-Stokes) to 'HO' (Higher-Order) should fix the issue.
  Here's why:

  - Full-Stokes ('FS'): Uses P2/P1 finite elements (P2 for velocity, P1 for pressure)
  - Higher-Order ('HO'): Uses P1 finite elements for velocity
  - SSA: Also uses P1 finite elements

  Since your periodic boundary setup requires P1 elements (finite_element==P1Enum),
  changing line 706 to:

  md = setflowequation(md, 'HO', 'all')

  Should resolve the assertion failure. The HO approximation is still a good physics
  model for ice flow (it's the Higher-Order approximation that includes most stress
  terms except some vertical shear components).

  This is a much simpler fix than reworking your periodic boundary conditions to work
  with P2/P1 elements.

I recall this being a problem:

https://issm.ess.uci.edu/forum/d/587-error-1d-freesurfacebaseanalysis/8

Based on that ISSM forum discussion, periodic boundaries 
  are not supported with Full-Stokes (FS). This is a fundamental limitation in ISSM.

  So your options are:

  1. Change to HO (recommended):
  md = setflowequation(md, 'HO', 'all')
  2. Change to SSA:
  md = setflowequation(md, 'SSA', 'all')
  3. Remove periodic boundaries and use different boundary conditions with FS (but
  this would change your experiment setup significantly)

  Given that you're doing a grid convergence study for experiment S4, HO is probably 
  your best choice since it:
  - Supports periodic boundaries
  - Uses P1 finite elements (compatible with vertex pairing)
  - Provides good physics approximation (includes most stress terms)
  - Is commonly used for ice sheet modeling

  The HO approximation should give you very similar results to FS for most ice flow
  problems, especially for the periodic flowline case you're studying.

LETS SEEEE IF THIS RUNS


nope crashes I am trying to run periodic_flowline.py... I am getting this error


```
  depth averaging Vx

  [0] ??? Error using ==> ./classes/Elements/Tria.cpp:181
  [0] AddBasalInput error message: not implemented yet

  -------------------------------------------------------------------------
  -
  Primary job  terminated normally, but 1 process returned
  a non-zero exit code. Per user-direction, the job has been aborted.
  -------------------------------------------------------------------------
  -
  -------------------------------------------------------------------------
  -
  mpiexec detected that one or more processes exited with non-zero status, 
  thus causing
  the job to be terminated. The first process to do so was:

    Process name: [[28705,1],0]
    Exit code:    1
  -------------------------------------------------------------------------
  -
  loading results from cluster
  ============================================================
     Binary file 165_S1_1.25.outbin not found                              
     
                                                              
     This typically happens when the run crashed.             
     Please check for error messages above or in the outlog   
  ============================================================

  WARNING: 165_S1_1.25.outbin does not exist
  Traceback (most recent call last):
    File "/home/ana/Desktop/code/Gadi/flowline/periodic_flowline.py", line 
  787, in <module>
      md = Solve(md)    
           ^^^^^^^^^
    File "/home/ana/Desktop/code/Gadi/flowline/periodic_flowline.py", line 
  435, in Solve
      return solve(md, 'Transient')
             ^^^^^^^^^^^^^^^^^^^^^^
    File "/home/ana/ISSM/bin/solve.py", line 164, in solve
      md = loadresultsfromcluster(md)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/home/ana/ISSM/bin/loadresultsfromcluster.py", line 68, in 
  loadresultsfromcluster
      remove(md.private.runtimename + '.tar.gz')
             ^^^^^^^^^^
  AttributeError: 'NoneType' object has no attribute 'private'
```

‚óè The error shows two main issues:

  1. AddBasalInput error message: not implemented yet - This is the core
  problem causing the crash
  2. AttributeError: 'NoneType' object has no attribute 'private' - This is
   a secondary error from cleanup after the crash

  The first error indicates that ISSM is trying to use a feature that's not
   implemented for your current configuration. Based on your log showing
  you switched from Full-Stokes (FS) to Higher-Order (HO), this suggests
  the issue might be related to:

  1. Basal boundary conditions - The error occurs during "depth averaging
  Vx" which is specific to HO/SSA models
  2. Missing basal inputs - HO models require different basal boundary
  condition setup than FS


NEED TO INVESTIGATE BOUNDARY CONDITION FOR BASE IF I WANT TO USE HO
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

